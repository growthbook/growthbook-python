name: Release
on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type (major, minor, patch)'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get all history and tags
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: true  # Get submodules if any
          persist-credentials: false
          fetch-tags: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools
          pip install -r requirements_dev.txt
          pip install -r requirements.txt

      - name: Check Git Files
        run: ls -la .git

      - name: Run tests
        run: pytest

      - name: Configure Git
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

      - name: Create Release & Publish to PyPI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          # Install tools
          pip install bump2version build twine
          
          # Get current version before bump
          CURRENT_VERSION=$(grep "__version__" growthbook/__init__.py | cut -d'"' -f2)
          echo "Current version: $CURRENT_VERSION"
          
          # 1. Bump version
          case "${{ github.event.inputs.release_type }}" in
            "major")
              bump2version major
              ;;
            "minor")
              bump2version minor
              ;;
            *)
              bump2version patch
              ;;
          esac
          
          # Validate version bump and tag creation
          NEW_VERSION=$(grep "__version__" growthbook/__init__.py | cut -d'"' -f2)
          echo "New version: $NEW_VERSION"
          
          # Check if version was actually bumped
          if [ "$CURRENT_VERSION" = "$NEW_VERSION" ]; then
            echo "Error: Version was not bumped"
            exit 1
          fi
          
          # Verify tag format
          TAG_NAME="v$NEW_VERSION"
          if ! git tag | grep -q "^$TAG_NAME$"; then
            echo "Error: Tag $TAG_NAME was not created properly"
            exit 1
          fi
          
          # 2. Build package
          python -m build
          
          # 3. Create GitHub Release
          VERSION=$NEW_VERSION  # Use already validated version
          git push && git push --tags
          
          # Verify tag was pushed
          if ! gh api repos/growthbook/growthbook-python/git/refs/tags/$TAG_NAME &>/dev/null; then
            echo "Error: Tag $TAG_NAME was not pushed to GitHub"
            exit 1
          fi
          
          gh release create "v${VERSION}" \
            --title "v${VERSION}" \
            --notes "Release v${VERSION}" \
            dist/*
          
          # 4. Publish to PyPI
          twine upload dist/*